// Generated by CoffeeScript 1.7.1

/*
namespace = (target, name, block) ->
	[target, name, block] = [(if typeof exports isnt 'undefined' then exports else window), arguments...] if arguments.length < 3
	top    = target
	target = target[item] or= {} for item in name.split '.'
	block target, top

namespace 'App.Load', (exports, top) ->
	exports.kdapp = kdapp
 */

(function() {
  var kiipApp;

  kiipApp = typeof exports !== "undefined" && exports !== null ? exports : window;

  kiipApp.kdapp = {
    tester: function() {
      alert('test');
    },
    initialize: function() {
      this.bindEvents();
    },
    bindEvents: function() {
      document.addEventListener("deviceready", this.onDeviceReady, false);
    },
    onDeviceReady: function() {
      kiipApp.kdapp.receivedEvent("deviceready");
    },
    receivedEvent: function(id) {
      var e, listeningElement, parentElement, pushNotification, receivedElement, _ref;
      parentElement = document.getElementById(id);
      listeningElement = parentElement.querySelector(".listening");
      receivedElement = parentElement.querySelector(".received");
      listeningElement.setAttribute("style", "display:none;");
      receivedElement.setAttribute("style", "display:block;");
      console.log("Received Event: " + id);
      pushNotification = window.plugins.pushNotification;
      try {
        console.log(device.cordova);
        if ((_ref = device.platform) === 'android' || _ref === 'Android') {
          alert("Register called Android");
          pushNotification.register(this.successHandler, this.errorHandler, {
            senderID: "636322237508",
            ecb: "kiipApp.kdapp.onNotificationGCM"
          });
        } else {
          alert("Register called APN");
          pushNotification.register(this.successHandler, this.errorHandler, {
            badge: "true",
            sound: "true",
            alert: "true",
            ecb: "kiipApp.kdapp.onNotificationAPN"
          });
        }
      } catch (_error) {
        e = _error;
        alert('device plugin error: ' + e);
      }
    },
    successHandler: function(result) {},
    errorHandler: function(error) {
      alert(error);
    },
    onNotificationGCM: function(e) {
      var pushNotification;
      pushNotification = window.plugins.pushNotification;
      try {
        kiipApp.kdapp.onGotReg(window.localStorage.getItem("reg_id"));
      } catch (_error) {
        e = _error;
        alert("window.localStorage.getItem " + e);
      }
      switch (e.event) {
        case "registered":
          if (e.regid.length > 0) {
            console.log("Regid " + e.regid);
            alert("registration id = " + e.regid);
            window.localStorage.setItem("reg_id", e.regid);
            return kiipApp.kdapp.onGotReg(e.regid);
          }
          break;
        case "message":
          return alert("message = " + e.message + " msgcnt = " + e.msgcnt);
        case "error":
          return alert("GCM error = " + e.msg);
        default:
          return alert("An unknown GCM event has occurred");
      }
    },
    onNotificationAPN: function(event) {
      var pushNotification, snd;
      pushNotification = window.plugins.pushNotification;
      alert("Running in JS - onNotificationAPN - Received a notification! " + event.alert);
      if (event.alert) {
        navigator.notification.alert(event.alert);
      }
      if (event.badge) {
        pushNotification.setApplicationIconBadgeNumber(this.successHandler, this.errorHandler, event.badge);
      }
      if (event.sound) {
        snd = new Media(event.sound);
        snd.play();
      }
    },
    onGotReg: function(regID) {
      var regInfo;
      regInfo = {
        device_id: regID
      };
      $.ajax({
        type: "POST",
        url: "http://test.krashdrive.com/kiip/getDeviceIDs",
        data: regInfo,
        dataType: "json"
      });
    }
  };

}).call(this);
